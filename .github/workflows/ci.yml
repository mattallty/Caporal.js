name: "Continous integration"

on:
  pull_request:
    branches:
      - "**"

jobs:
  run-tests:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        node: ["12", "14", "16"]
        os: ["macos-latest", "ubuntu-latest", "windows-latest"]

    name: "node ${{ matrix.node }} / ${{ matrix.os }}"
    steps:
      - uses: actions/checkout@v3
      - name: Setup Node.js v${{ matrix.node }} on ${{ matrix.os }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node }}

      - name: Install dependencies
        run: npm install

        # build before testing as some tests actually test the build
      - name: Build
        run: npm run build

      - name: Lint
        run: npm run lint

      - name: Run tests
        run: npm test

      - name: Run dist tests
        run: npm run test:dist

  #      - name: Jest Annotations & Coverage
  #        if: ${{ matrix.node == '12' && matrix.os == 'ubuntu-latest' }}
  #        uses: mattallty/jest-github-action@v1.0.2
  #        env:
  #          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-preview:
    name: "Deploy preview website"
    runs-on: ubuntu-latest
    needs: run-tests
    continue-on-error: true
    if: ${{ github.event_name == 'pull_request' || github.ref != 'master' }}
    steps:
      - uses: actions/checkout@v2
      - name: Compute vars
        id: compute-vars
        run: |
          clean_ref=$(basename "${{ github.head_ref }}")
          clean_sha=$(echo "${{ github.sha }}" | cut -c1-7)
          echo "::set-output name=site_url_with_ref::${clean_ref}.caporal.run"
          echo "::set-output name=site_url_with_sha::${clean_sha}.caporal.run"
      - name: Vercel Action
        uses: amondnet/vercel-action@v20.0.1
        id: now-deploy
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          github-comment: false
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.ZEIT_ORG_ID}}
          vercel-project-id: ${{ secrets.ZEIT_PROJECT_ID}}
          working-directory: example/static
          alias-domains: |
            ${{ steps.compute-vars.outputs.site_url_with_ref }}
            ${{ steps.compute-vars.outputs.site_url_with_sha }}

      # - uses: amondnet/now-deployment@v2
      #   id: now-deploy
      #   with:
      #     github-comment: false
      #     zeit-token: ${{ secrets.ZEIT_TOKEN }}
      #     now-args: "-A now.preview.json"
      #     now-org-id: ${{ secrets.ZEIT_ORG_ID}}
      #     now-project-id: ${{ secrets.ZEIT_PROJECT_ID}}

      - uses: actions/setup-node@v1
        with:
          node-version: 16

      - name: Install dependencies
        run: npm ci

      # - name: Alias
      #   id: caporal-preview
      #   env:
      #     NOW_ORG_ID: ${{ secrets.ZEIT_ORG_ID}}
      #     NOW_PROJECT_ID: ${{ secrets.ZEIT_PROJECT_ID}}
      #   run: |
      #     clean_url=$(echo "${{Â steps.now-deploy.outputs.preview-url }}" | cut -c9-)
      #     clean_ref=$(basename "${{ github.head_ref }}")
      #     clean_sha=$(echo "${{ github.sha }}" | cut -c1-7)
      #     npm run now -- alias -A now.preview.json --token ${{ secrets.ZEIT_TOKEN }} set $clean_url ${clean_ref}.caporal.run
      #     npm run now -- alias -A now.preview.json --token ${{ secrets.ZEIT_TOKEN }} set $clean_url ${clean_sha}.caporal.run
      #     echo "::set-output name=url_ref::https://${clean_ref}.caporal.run"
      #     echo "::set-output name=url_sha::https://${clean_sha}.caporal.run"

      - uses: chrnorm/deployment-action@releases/v1
        name: Create GitHub deployment for commit
        id: commit-deployment
        if: ${{ success() }}
        with:
          initial_status: success
          token: ${{ secrets.GITHUB_TOKEN }}
          target_url: https://${{ steps.compute-vars.outputs.site_url_with_sha }}
          environment: Commit-preview

      - uses: chrnorm/deployment-action@releases/v1
        name: Create GitHub deployment for branch
        id: branch-deployment
        if: ${{ success() }}
        with:
          initial_status: success
          token: ${{ secrets.GITHUB_TOKEN }}
          target_url: https://${{ steps.compute-vars.outputs.site_url_with_ref }}
          environment: Branch-preview

      - name: comment PR
        uses: unsplash/comment-on-pr@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          msg: |
            :rocket: Caporal website preview available at: https://${{ steps.compute-vars.outputs.site_url_with_ref }}
            You can also checkout the [coverage report here](https://${{ steps.compute-vars.outputs.site_url_with_ref }}/coverage/lcov-report/).
          check_for_duplicate_msg: true
